<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Focus Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0f141e',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* Animaciones */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Usamos el selector de hermano para tachar el texto cuando el checkbox está marcado */
        .task-checkbox:checked + span {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        /* Scrollbar personalizado */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
        }

        /* --- Estilos para el Anillo de Progreso --- */
        .progress-ring-base {
            position: relative;
            background: transparent; 
        }

        .progress-ring-inner {
            border-radius: 9999px;
            position: absolute;
            /* 8px de grosor de anillo (16px total de margen/padding) */
            width: calc(100% - 16px); 
            height: calc(100% - 16px);
            top: 8px; 
            left: 8px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.5s;
        }

        /* Slider personalizado para volumen */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none; 
        }

        /* Drag and Drop Styles */
        .draggable-source {
            opacity: 0.4;
            border: 2px dashed #cbd5e1;
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 transition-colors duration-500 bg-gray-100 dark:bg-gray-950" id="body-bg">

    <div id="main-card-wrapper" class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md overflow-hidden relative transition-colors duration-500">
        
        <!-- Header - Diseño Balanceado -->
        <div class="p-5 flex justify-between items-center border-b border-gray-100 dark:border-gray-700 relative">
            
            <!-- Izquierda: Botón PiP -->
            <div class="z-20 relative">
                <button id="pip-btn" onclick="togglePiP()" class="hidden w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 hover:text-blue-500 dark:hover:text-blue-400 transition shadow-sm" title="Modo Mini Ventana">
                    <i class="fas fa-external-link-alt text-sm"></i>
                </button>
            </div>

            <!-- Centro: Título/Estado (Absoluto) -->
            <div class="absolute inset-x-0 text-center top-1/2 -translate-y-1/2 pointer-events-none">
                <h1 class="text-xl font-bold text-gray-800 dark:text-white pointer-events-auto">Pomodoro Focus</h1>
                <p class="text-gray-500 dark:text-gray-400 text-[10px] mt-0.5 pointer-events-auto uppercase tracking-wider" id="status-text">Listo para empezar</p>
            </div>

            <!-- Derecha: Controles Principales -->
            <div class="flex gap-2 z-20 relative">
                <button onclick="toggleDarkMode()" class="p-2 w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="Modo Oscuro">
                    <i class="fas fa-moon" id="dark-mode-icon"></i>
                </button>
                <button onclick="toggleSettings()" class="p-2 w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition" title="Configuración">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Settings Panel (Hidden by default) -->
        <div id="settings-panel" class="hidden bg-gray-50 dark:bg-gray-750 p-6 border-b border-gray-100 dark:border-gray-700 fade-enter transition-all duration-300">
            <!-- Header Configuración con Botón Cerrar -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wide">Configuración</h3>
                <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition" title="Cerrar configuración">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Tiempos -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-gray-500 dark:text-gray-400 block mb-1">Flow (min)</label>
                    <input type="number" id="work-input" value="20" min="1" max="60" 
                           class="w-full bg-white dark:bg-gray-800 border dark:border-gray-600 rounded p-2 text-gray-700 dark:text-white focus:ring-2 outline-none transition" onchange="updateSettings()">
                </div>
                <div>
                    <label class="text-xs text-gray-500 dark:text-gray-400 block mb-1">Descanso (min)</label>
                    <input type="number" id="break-input" value="5" min="1" max="30" 
                           class="w-full bg-white dark:bg-gray-800 border dark:border-gray-600 rounded p-2 text-gray-700 dark:text-white focus:ring-2 outline-none transition" onchange="updateSettings()">
                </div>
            </div>

            <!-- Sonido Ambiental -->
            <div class="mb-6 p-3 bg-gray-100 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
                <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 block mb-2 flex justify-between items-center">
                    <span><i class="fas fa-headphones-alt mr-1"></i> Sonido de Fondo (Focus)</span>
                    <span id="ambient-status" class="text-[10px] uppercase text-gray-400">Off</span>
                </label>
                <div class="flex gap-2 mb-2">
                    <select id="ambient-select" class="flex-1 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded p-2 text-sm text-gray-700 dark:text-white outline-none" onchange="handleAmbientChange()">
                        <option value="off">Apagado</option>
                        <option value="white">Ruido Blanco (Enfoque)</option>
                        <option value="rain">Lluvia Suave</option>
                        <option value="river">Río Profundo</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-volume-down text-gray-400 text-xs"></i>
                    <input type="range" id="ambient-volume" min="0" max="1" step="0.05" value="0.3" 
                           class="w-full h-1 bg-gray-300 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-blue-500"
                           oninput="handleAmbientVolume(this.value)">
                </div>
            </div>

            <!-- Tema de Color -->
            <div class="mb-6">
                <label class="text-xs text-gray-500 dark:text-gray-400 block mb-2">Tema de Color</label>
                <div class="flex gap-3">
                    <button onclick="setTheme('default')" class="w-8 h-8 rounded-full bg-rose-500 ring-2 ring-offset-2 ring-transparent focus:ring-gray-400"></button>
                    <button onclick="setTheme('ocean')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-transparent focus:ring-gray-400"></button>
                    <button onclick="setTheme('nature')" class="w-8 h-8 rounded-full bg-emerald-500 ring-2 ring-offset-2 ring-transparent focus:ring-gray-400"></button>
                    <button onclick="setTheme('violet')" class="w-8 h-8 rounded-full bg-violet-500 ring-2 ring-offset-2 ring-transparent focus:ring-gray-400"></button>
                </div>
            </div>

            <!-- Sonido Fin -->
            <div class="mb-6">
                <label class="text-xs text-gray-500 dark:text-gray-400 block mb-2">Sonido al finalizar</label>
                <select id="sound-select" class="w-full bg-white dark:bg-gray-800 border dark:border-gray-600 rounded p-2 text-gray-700 dark:text-white outline-none">
                    <option value="digital">Digital (Beep)</option>
                    <option value="bell">Campana suave</option>
                    <option value="melody">Melodía Arcade</option>
                    <option value="mute">Silencio</option>
                </select>
                <button onclick="previewSound()" class="text-xs text-blue-500 mt-1 hover:underline">Probar alarma</button>
            </div>

            <!-- Botones de Acción (Listo / Reset) -->
             <div class="pt-4 border-t border-gray-200 dark:border-gray-600 flex flex-col gap-3">
                <button onclick="toggleSettings()" class="w-full py-2 bg-gray-800 dark:bg-white text-white dark:text-gray-900 rounded-lg font-bold shadow-md hover:opacity-90 transition">
                    LISTO <i class="fas fa-check ml-1"></i>
                </button>
                
                <button onclick="hardReset()" class="w-full py-2 text-xs font-bold text-red-500 border border-red-200 dark:border-red-900/30 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition">
                    <i class="fas fa-trash mr-1"></i> RESTABLECER TODO
                </button>
            </div>
        </div>

        <!-- Timer Section WRAPPER for PiP -->
        <div id="timer-container" class="p-8 text-center relative z-10 transition-colors duration-500">
            <!-- Outer Ring (gets the gradient) - TAMAÑO RESPONSIVE -->
            <div class="progress-ring-base w-56 h-56 sm:w-64 sm:h-64 mx-auto flex items-center justify-center rounded-full mb-8 transition-all duration-500" id="timer-ring">
                <!-- Inner Circle (hides center, contains text) -->
                <div class="progress-ring-inner text-center z-10 bg-white dark:bg-gray-800 transition-colors duration-500">
                    <!-- TAMAÑO DE TEXTO RESPONSIVE -->
                    <div id="timer-display" class="text-5xl sm:text-6xl font-bold text-gray-800 dark:text-white tracking-wider tabular-nums">20:00</div>
                    <div id="current-mode-badge" class="mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide transition-colors">Flow</div>
                    <!-- Contador de Pomodoros movido y simplificado -->
                    <p id="pomodoro-counter" class="text-xs mt-1 font-medium text-gray-500 dark:text-gray-400"></p>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-center gap-4">
                <button id="toggle-btn" class="text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg transform active:scale-95 transition text-xl transition-colors duration-300" onclick="toggleTimer()">
                    <i class="fas fa-play" id="play-icon"></i>
                </button>
                <button class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 w-16 h-16 rounded-full flex items-center justify-center shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transform active:scale-95 transition text-xl" onclick="resetTimer()">
                    <i class="fas fa-redo-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Placeholder para cuando el timer está en PiP -->
        <div id="pip-placeholder" class="hidden p-10 text-center text-gray-400 dark:text-gray-500 flex flex-col items-center justify-center min-h-[300px]">
            <i class="fas fa-external-link-alt text-4xl mb-4 opacity-50"></i>
            <p>El temporizador está en una ventana externa</p>
            <button onclick="documentPictureInPicture.window.close()" class="mt-4 text-sm text-blue-500 hover:underline">Traer de vuelta</button>
        </div>

        <!-- Tasks Section -->
        <div id="tasks-section" class="bg-gray-50 dark:bg-gray-900/50 p-6 border-t border-gray-100 dark:border-gray-700 transition-colors">
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2">
                <i class="fas fa-list-check"></i> Lista de Tareas
            </h2>
            
            <div class="flex gap-2 mb-4 items-center">
                <!-- Estimación input -->
                <div class="relative w-16" title="Estimación de Pomodoros">
                    <i class="fas fa-stopwatch absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input type="number" id="task-est" value="1" min="1" max="10" 
                           class="w-full pl-6 pr-1 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg text-center text-sm focus:outline-none focus:border-gray-500 transition-colors">
                </div>
                
                <input type="text" id="task-input" placeholder="Nueva tarea..." 
                       class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg px-4 py-2 focus:outline-none focus:border-gray-500 shadow-sm transition-colors"
                       onkeypress="handleEnter(event)">
                <button id="add-task-btn" onclick="addTask()" class="text-white px-4 py-2 rounded-lg hover:opacity-90 transition shadow-sm">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <ul id="task-list" class="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar pb-2">
                <!-- Tareas serán inyectadas por JS -->
            </ul>
        </div>
        
        <!-- Progress Bar -->
        <div class="h-1.5 w-full bg-gray-200 dark:bg-gray-700">
            <div id="progress-bar" class="h-full transition-all duration-1000" style="width: 100%"></div>
        </div>
    </div>

    <script>
        // --- Configuración y Estado ---
        let state = {
            timeLeft: 1200,
            totalTime: 1200,
            isRunning: false,
            isWorkMode: true,
            timerInterval: null,
            theme: 'ocean', 
            sound: 'digital',
            progressColor: '', 
            trackColor: '',
            pomodoroCount: 0, 
            tasks: [], // Estructura: { id, text, completed, est: 1, act: 0 }
            activeTaskId: null, // ID de la tarea actualmente enfocada
            // Nuevos estados para ambiente
            ambientType: 'off',
            ambientVolume: 0.3
        };

        // --- Definición de Temas ---
        const themes = {
            default: {
                work: { color: 'rose', hex: '#e11d48', bg: 'bg-rose-500', text: 'text-rose-600', ring: 'border-rose-100', badge: 'bg-rose-100' },
                break: { color: 'emerald', hex: '#059669', bg: 'bg-emerald-500', text: 'text-emerald-600', ring: 'border-emerald-100', badge: 'bg-emerald-100' }
            },
            ocean: {
                work: { color: 'blue', hex: '#2563eb', bg: 'bg-blue-600', text: 'text-blue-600', ring: 'border-blue-100', badge: 'bg-blue-100' },
                break: { color: 'cyan', hex: '#0891b2', bg: 'bg-cyan-600', text: 'text-cyan-600', ring: 'border-cyan-100', badge: 'bg-cyan-100' }
            },
            nature: {
                work: { color: 'emerald', hex: '#059669', bg: 'bg-emerald-600', text: 'text-emerald-600', ring: 'border-emerald-100', badge: 'bg-emerald-100' }, 
                break: { color: 'lime', hex: '#65a30d', bg: 'bg-lime-600', text: 'text-lime-600', ring: 'border-lime-100', badge: 'bg-lime-100' }
            },
            violet: {
                work: { color: 'violet', hex: '#7c3aed', bg: 'bg-violet-600', text: 'text-violet-600', ring: 'border-violet-100', badge: 'bg-violet-100' },
                break: { color: 'fuchsia', hex: '#c026d3', bg: 'bg-fuchsia-600', text: 'text-fuchsia-600', ring: 'border-fuchsia-100', badge: 'bg-fuchsia-100' }
            }
        };

        // --- Referencias DOM ---
        const els = {
            display: document.getElementById('timer-display'),
            ring: document.getElementById('timer-ring'),
            badge: document.getElementById('current-mode-badge'),
            progressBar: document.getElementById('progress-bar'),
            toggleBtn: document.getElementById('toggle-btn'),
            playIcon: document.getElementById('play-icon'),
            statusText: document.getElementById('status-text'),
            addTaskBtn: document.getElementById('add-task-btn'),
            workInput: document.getElementById('work-input'),
            breakInput: document.getElementById('break-input'),
            bodyBg: document.getElementById('body-bg'),
            settingsPanel: document.getElementById('settings-panel'),
            darkModeIcon: document.getElementById('dark-mode-icon'),
            soundSelect: document.getElementById('sound-select'),
            pomodoroCounter: document.getElementById('pomodoro-counter'),
            // Nuevos refs ambiente
            ambientSelect: document.getElementById('ambient-select'),
            ambientVolume: document.getElementById('ambient-volume'),
            ambientStatus: document.getElementById('ambient-status'),
            taskEst: document.getElementById('task-est'),
            pipBtn: document.getElementById('pip-btn')
        };

        // --- Persistencia con LocalStorage ---

        function saveState() {
            try {
                const configToSave = {
                    workTime: parseInt(els.workInput.value),
                    breakTime: parseInt(els.breakInput.value),
                    theme: state.theme,
                    sound: els.soundSelect.value,
                    pomodoroCount: state.pomodoroCount,
                    isDarkMode: document.documentElement.classList.contains('dark'),
                    ambientType: state.ambientType,
                    ambientVolume: state.ambientVolume,
                    activeTaskId: state.activeTaskId
                };
                localStorage.setItem('pomodoroConfig', JSON.stringify(configToSave));
                localStorage.setItem('pomodoroTasks', JSON.stringify(state.tasks));

            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
            }
        }

        function loadState() {
            try {
                const configStr = localStorage.getItem('pomodoroConfig');
                const tasksStr = localStorage.getItem('pomodoroTasks');

                if (configStr) {
                    const config = JSON.parse(configStr);

                    els.workInput.value = config.workTime || 20;
                    els.breakInput.value = config.breakTime || 5;
                    els.soundSelect.value = config.sound || 'digital';
                    state.theme = config.theme || 'ocean';
                    state.pomodoroCount = config.pomodoroCount || 0;
                    state.activeTaskId = config.activeTaskId || null;
                    
                    // Cargar ambient settings
                    state.ambientType = config.ambientType || 'off';
                    state.ambientVolume = config.ambientVolume !== undefined ? config.ambientVolume : 0.3;
                    els.ambientSelect.value = state.ambientType;
                    els.ambientVolume.value = state.ambientVolume;
                    
                    if (config.isDarkMode) {
                        document.documentElement.classList.add('dark');
                        els.darkModeIcon.className = "fas fa-sun";
                    } else {
                         document.documentElement.classList.remove('dark');
                         els.darkModeIcon.className = "fas fa-moon";
                    }
                }

                if (tasksStr) {
                    state.tasks = JSON.parse(tasksStr);
                    // Migración simple para tareas viejas que no tengan est/act
                    state.tasks = state.tasks.map(t => ({
                        ...t,
                        est: t.est || 1,
                        act: t.act || 0
                    }));
                    renderTasks(); 
                }

            } catch (e) {
                console.warn("No se encontraron datos guardados:", e);
            }
        }

        // --- Funciones Principales ---

        function init() {
            loadState(); 
            requestNotificationPermission();
            updateSettings(true);
            applyThemeStyles();
            updateAmbientStatusUI(); // Actualizar texto de UI ambiente
            
            // Verificar soporte PiP
            if ('documentPictureInPicture' in window) {
                els.pipBtn.classList.remove('hidden');
            }
        }

        function hardReset() {
            if(confirm("¿Estás seguro de que quieres borrar todos los datos y tareas?")) {
                localStorage.removeItem('pomodoroConfig');
                localStorage.removeItem('pomodoroTasks');
                location.reload();
            }
        }

        function toggleTimer() {
            if (state.isRunning) {
                pauseTimer();
            } else {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                startTimer();
            }
        }

        function startTimer() {
            if (state.isRunning) return;
            state.isRunning = true;
            els.playIcon.classList.replace('fa-play', 'fa-pause');
            els.statusText.textContent = state.isWorkMode ? "¡A concentrarse!" : "¡A relajarse!";
            
            // Iniciar ambiente si es modo trabajo
            checkAndPlayAmbient();

            state.timerInterval = setInterval(() => {
                if (state.timeLeft > 0) {
                    state.timeLeft--;
                    updateDisplay();
                } else {
                    finishTimer();
                }
            }, 1000);
        }

        function pauseTimer() {
            state.isRunning = false;
            clearInterval(state.timerInterval);
            els.playIcon.classList.replace('fa-pause', 'fa-play');
            els.statusText.textContent = "Pausado";
            
            // Pausar ambiente con fade out
            stopAmbient();
        }

        function resetTimer() {
            pauseTimer();
            updateSettings(true);
            els.statusText.textContent = "Listo para empezar";
        }

        function finishTimer() {
            pauseTimer(); // Esto también detiene el sonido ambiental
            playSound(); // Toca alarma
            
            let notificationTitle = "¡Tiempo de Descanso Terminado!";
            let notificationBody = "Volvamos al Flow.";
            
            if (state.isWorkMode) {
                state.pomodoroCount++;
                notificationTitle = "¡Flow Terminado!";
                notificationBody = `Tómate un respiro de ${els.breakInput.value} minutos. Ciclo ${state.pomodoroCount} completado.`;
                
                // Actualizar la tarea activa si existe
                if (state.activeTaskId) {
                    const taskIndex = state.tasks.findIndex(t => t.id === state.activeTaskId);
                    if (taskIndex !== -1) {
                        state.tasks[taskIndex].act = (state.tasks[taskIndex].act || 0) + 1;
                        renderTasks(); // Re-renderizar para pintar el tomate
                    }
                }
            }

            sendNotification(notificationTitle, notificationBody);
            
            saveState();

            state.isWorkMode = !state.isWorkMode;
            applyThemeStyles();
            updateSettings(true);
            
            els.statusText.textContent = state.isWorkMode ? "¡Descanso terminado! Volvamos al Flow." : "¡Tiempo cumplido! Tómate un respiro.";
            
            setTimeout(() => {
                if(!state.isRunning) els.statusText.textContent = "Listo para empezar";
            }, 3000);
        }

        function updateDisplay() {
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            els.display.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            const pct = (state.timeLeft / state.totalTime) * 100;

            els.progressBar.style.width = `${pct}%`;
            
            const fillDeg = (pct / 100) * 360; 
            els.ring.style.background = `conic-gradient(
                ${state.progressColor} 0deg ${fillDeg}deg,
                ${state.trackColor} ${fillDeg}deg 360deg
            )`;

            if (state.pomodoroCount > 0) {
                els.pomodoroCounter.textContent = `Ciclo ${state.pomodoroCount}`;
            } else {
                els.pomodoroCounter.textContent = ''; 
            }

            document.title = `${els.display.textContent} - ${state.isWorkMode ? 'Flow' : 'Descanso'}`;
        }

        // --- Configuración y Temas ---

        function toggleSettings() {
            els.settingsPanel.classList.toggle('hidden');
        }

        function updateSettings(forceReset = false) {
            const w = parseInt(els.workInput.value) || 20;
            const b = parseInt(els.breakInput.value) || 5;
            
            if (!state.isRunning || forceReset) {
                state.totalTime = (state.isWorkMode ? w : b) * 60;
                if (!state.isRunning || forceReset) {
                    state.timeLeft = state.totalTime;
                    updateDisplay();
                }
            }
            saveState(); 
        }

        function setTheme(themeName) {
            state.theme = themeName;
            applyThemeStyles();
            saveState(); 
        }

        function applyThemeStyles() {
            const themeSet = themes[state.theme];
            const activeSet = state.isWorkMode ? themeSet.work : themeSet.break;
            const isDark = document.documentElement.classList.contains('dark');

            state.progressColor = activeSet.hex;
            state.trackColor = isDark ? 'rgba(75, 85, 99, 0.5)' : '#e5e7eb'; 
            
            els.ring.className = `progress-ring-base w-56 h-56 sm:w-64 sm:h-64 mx-auto flex items-center justify-center rounded-full mb-8 transition-colors duration-500`;

            els.badge.className = `mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide transition-colors ${activeSet.badge} ${activeSet.text}`;
            els.badge.textContent = state.isWorkMode ? "Flow" : "Descanso";

            els.toggleBtn.className = `text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg transform active:scale-95 transition text-xl transition-colors duration-300 ${activeSet.bg}`;

            els.addTaskBtn.className = `text-white px-4 py-2 rounded-lg hover:opacity-90 transition shadow-sm ${themeSet.work.bg}`;

            els.progressBar.className = `h-full transition-all duration-1000 ${activeSet.bg}`;
            
            if (!isDark) {
                els.bodyBg.style.backgroundColor = state.isWorkMode ? '#fff' : '#f8fafc'; 
            } else {
                els.bodyBg.style.backgroundColor = '';
            }
            
            if (!state.isRunning) {
                 els.statusText.textContent = "Listo para empezar";
            }
            
            // Si hay ventana PiP, actualiza su estilo también
            if (window.documentPictureInPicture && window.documentPictureInPicture.window) {
                 const pipBody = window.documentPictureInPicture.window.document.body;
                 pipBody.className = `flex flex-col items-center justify-center h-full transition-colors duration-500 ${isDark ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'}`;
            }

            updateDisplay(); 
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            
            const isDark = html.classList.contains('dark');
            els.darkModeIcon.className = isDark ? "fas fa-sun" : "fas fa-moon";
            
            applyThemeStyles();
            saveState(); 
            
            // Sincronizar PiP
            if (window.documentPictureInPicture && window.documentPictureInPicture.window) {
                 const pipWin = window.documentPictureInPicture.window;
                 if (isDark) pipWin.document.documentElement.classList.add('dark');
                 else pipWin.document.documentElement.classList.remove('dark');
                 // Forzar actualización de colores de fondo en PiP
                 const pipBody = pipWin.document.body;
                 pipBody.className = `flex flex-col items-center justify-center h-full transition-colors duration-500 ${isDark ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'}`;
            }
        }

        // --- SISTEMA DE AUDIO (Ambient + Alarma) ---

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Variables Ambientales
        let ambientSourceNode = null;
        let ambientGainNode = null;

        // Manejo de UI Ambient
        function handleAmbientChange() {
            state.ambientType = els.ambientSelect.value;
            updateAmbientStatusUI();
            saveState();
            
            // Si está corriendo y en modo trabajo, cambiar sonido en vivo
            if (state.isRunning && state.isWorkMode) {
                stopAmbient(0.2); // Parar actual rapido
                setTimeout(() => checkAndPlayAmbient(), 250); // Iniciar nuevo
            }
        }

        function handleAmbientVolume(val) {
            state.ambientVolume = parseFloat(val);
            saveState();
            if (ambientGainNode) {
                ambientGainNode.gain.setTargetAtTime(state.ambientVolume, audioCtx.currentTime, 0.1);
            }
        }

        function updateAmbientStatusUI() {
            const map = { 'off': 'Off', 'white': 'Ruido Blanco', 'rain': 'Lluvia', 'river': 'Río' };
            els.ambientStatus.textContent = map[state.ambientType] || 'Off';
        }

        // Lógica de generación de ruido procedural
        function checkAndPlayAmbient() {
            if (state.ambientType === 'off' || !state.isWorkMode) return;
            playAmbient(state.ambientType);
        }

        function playAmbient(type) {
            // Asegurar contexto activo
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // Limpiar anterior si existe
            if (ambientSourceNode) { stopAmbient(0); }

            // 1. Crear Buffer de Ruido Blanco (Base)
            // 2 segundos de buffer es suficiente para loopear sin que se note el corte
            const bufferSize = 2 * audioCtx.sampleRate;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                // Math.random() es [0,1], lo pasamos a [-1,1]
                data[i] = Math.random() * 2 - 1; 
            }

            ambientSourceNode = audioCtx.createBufferSource();
            ambientSourceNode.buffer = buffer;
            ambientSourceNode.loop = true;

            // 2. Configurar volumen
            ambientGainNode = audioCtx.createGain();
            ambientGainNode.gain.setValueAtTime(0, audioCtx.currentTime); // Empezar en silencio (fade in)
            
            // 3. Cadena de Audio y Filtros según tipo
            if (type === 'white') {
                // Ruido blanco puro: Source -> Gain -> Dest
                ambientSourceNode.connect(ambientGainNode);
            } 
            else if (type === 'rain' || type === 'river') {
                // Ruido Rosa/Marron (simulado con filtros LowPass)
                // Usamos un filtro LowPass para suavizar el ruido blanco
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                
                if (type === 'rain') {
                    filter.frequency.value = 800; // Frecuencia de corte para lluvia
                    filter.Q.value = 0.5;
                } else { // river (Brown noise-ish)
                    filter.frequency.value = 300; // Más grave para río/cascada lejana
                    filter.Q.value = 1;
                }
                
                // Conectar: Source -> Filter -> Gain -> Dest
                ambientSourceNode.connect(filter);
                filter.connect(ambientGainNode);
            }

            ambientGainNode.connect(audioCtx.destination);
            
            // Start
            ambientSourceNode.start();
            
            // Fade In (2 segundos)
            ambientGainNode.gain.linearRampToValueAtTime(state.ambientVolume, audioCtx.currentTime + 2);
        }

        function stopAmbient(fadeTime = 1.5) {
            if (ambientGainNode && ambientSourceNode) {
                const stopTime = audioCtx.currentTime + fadeTime;
                // Fade Out
                ambientGainNode.gain.setValueAtTime(ambientGainNode.gain.value, audioCtx.currentTime);
                ambientGainNode.gain.linearRampToValueAtTime(0, stopTime);
                
                // Detener source después del fade
                ambientSourceNode.stop(stopTime);
                
                // Limpiar referencias despues del stop (aprox)
                setTimeout(() => {
                    // Verificación extra por si se inició otro sonido mientras tanto
                    if (audioCtx.currentTime >= stopTime) {
                        // Solo nullificar si no se ha reasignado
                    }
                }, fadeTime * 1000);
            }
        }

        // --- Alarma de Fin (Existente) ---
        function previewSound() {
            const selected = els.soundSelect.value;
            generateSound(selected);
        }
        
        function playSound() {
            const selected = els.soundSelect.value;
            generateSound(selected);
        }

        function generateSound(type) {
            if (type === 'mute') return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'digital') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } 
            else if (type === 'bell') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 1.5);
            }
            else if (type === 'melody') {
                playNote(659, 0, 0.1); 
                playNote(659, 0.15, 0.1);
                playNote(659, 0.3, 0.1);
                playNote(523, 0.45, 0.1);
                playNote(783, 0.6, 0.2);
            }
        }

        function playNote(freq, startTime, duration) {
            const osc = audioCtx.createOscillator();
            const gn = audioCtx.createGain();
            osc.connect(gn);
            gn.connect(audioCtx.destination);
            osc.type = 'square';
            osc.frequency.value = freq;
            gn.gain.setValueAtTime(0.1, audioCtx.currentTime + startTime);
            gn.gain.linearRampToValueAtTime(0, audioCtx.currentTime + startTime + duration);
            osc.start(audioCtx.currentTime + startTime);
            osc.stop(audioCtx.currentTime + startTime + duration);
        }

        // --- Notificaciones del Navegador ---

        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Este navegador no soporta notificaciones.");
            } else if (Notification.permission === "default") {
                Notification.requestPermission();
            }
        }

        function sendNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: 'https://placehold.co/64x64/059669/ffffff?text=PF'
                });
            }
        }

        // --- Tareas con Persistencia y Drag & Drop ---

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = ''; 
            
            state.tasks.forEach((task, index) => {
                const isActive = state.activeTaskId === task.id;
                const li = document.createElement('li');
                li.className = `draggable-item flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border ${isActive ? 'border-blue-500 dark:border-blue-400 ring-1 ring-blue-500/20' : 'border-gray-100 dark:border-gray-700'} fade-enter group transition-all`;
                li.setAttribute('data-id', task.id);
                li.setAttribute('draggable', 'true'); // Habilitar arrastre
                
                // Generar tomates
                let tomatoesHTML = '';
                const totalDots = Math.max(task.est || 1, task.act || 0);
                for(let i=0; i<totalDots; i++) {
                    if (i < (task.act || 0)) {
                        tomatoesHTML += `<i class="fas fa-circle text-[10px] text-red-500"></i>`; // Lleno
                    } else {
                        tomatoesHTML += `<i class="far fa-circle text-[10px] text-gray-300 dark:text-gray-600"></i>`; // Vacío
                    }
                }

                li.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden flex-1">
                        <!-- Handle Drag -->
                        <div class="drag-handle text-gray-300 hover:text-gray-500 cursor-grab px-1">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                        
                        <!-- Boton Foco -->
                        <button onclick="setActiveTask('${task.id}')" title="${isActive ? 'Tarea Activa' : 'Fijar Foco'}" 
                                class="w-6 h-6 flex items-center justify-center rounded-full transition-colors ${isActive ? 'text-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-300 hover:text-blue-400'}">
                            <i class="fas fa-crosshairs"></i>
                        </button>

                        <input type="checkbox" class="task-checkbox w-4 h-4 cursor-pointer accent-gray-700 dark:accent-gray-500" 
                               ${task.completed ? 'checked' : ''} onchange="handleTaskToggle('${task.id}', this.checked)">
                        
                        <div class="flex flex-col overflow-hidden min-w-0">
                            <span class="text-gray-700 dark:text-gray-300 truncate text-sm font-medium ${task.completed ? 'line-through opacity-50' : ''}">${task.text.replace(/</g, "&lt;")}</span>
                            <div class="flex gap-1 mt-1">
                                ${tomatoesHTML}
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteTask('${task.id}')" class="ml-2 text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition opacity-0 group-hover:opacity-100">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                
                // Eventos Drag & Drop
                addDragEvents(li);
                
                list.appendChild(li); 
            });
        }
        
        // --- Lógica Drag & Drop ---
        let draggedItem = null;

        function addDragEvents(item) {
            item.addEventListener('dragstart', function(e) {
                draggedItem = item;
                setTimeout(() => item.classList.add('draggable-source'), 0);
            });

            item.addEventListener('dragend', function() {
                setTimeout(() => {
                    item.classList.remove('draggable-source');
                    draggedItem = null;
                }, 0);
                // Guardar nuevo orden al terminar
                saveOrderFromDOM();
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault(); // Necesario para permitir drop
                const list = document.getElementById('task-list');
                const afterElement = getDragAfterElement(list, e.clientY);
                if (afterElement == null) {
                    list.appendChild(draggedItem);
                } else {
                    list.insertBefore(draggedItem, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.draggable-source)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function saveOrderFromDOM() {
            const listItems = document.querySelectorAll('#task-list li');
            const newOrderIds = Array.from(listItems).map(li => li.getAttribute('data-id'));
            
            // Reordenar el array state.tasks basado en los IDs del DOM
            const newTasksArray = [];
            newOrderIds.forEach(id => {
                const task = state.tasks.find(t => t.id === id);
                if (task) newTasksArray.push(task);
            });
            
            state.tasks = newTasksArray;
            saveState();
        }

        function setActiveTask(id) {
            // Toggle: si ya es activa, desactivarla
            if (state.activeTaskId === id) {
                state.activeTaskId = null;
            } else {
                state.activeTaskId = id;
            }
            saveState();
            renderTasks();
        }
        
        function handleTaskToggle(id, isChecked) {
            const taskIndex = state.tasks.findIndex(t => t.id === id);
            if (taskIndex !== -1) {
                state.tasks[taskIndex].completed = isChecked;
                saveState(); 
                renderTasks(); // Re-render para tachar estilo
            }
        }

        function handleEnter(e) { if (e.key === 'Enter') addTask(); }

        function addTask() {
            const input = document.getElementById('task-input');
            const estInput = document.getElementById('task-est');
            const text = input.value.trim();
            const est = parseInt(estInput.value) || 1;
            
            if (!text) return;

            const newTask = {
                id: generateId(),
                text: text,
                completed: false,
                est: est,
                act: 0
            };
            
            // Agrega la tarea al inicio
            state.tasks.unshift(newTask); 
            // Si es la única tarea, hacerla activa automáticamente
            if (state.tasks.length === 1) state.activeTaskId = newTask.id;

            saveState(); 
            renderTasks(); 

            input.value = "";
            estInput.value = "1";
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(task => task.id !== id);
            if (state.activeTaskId === id) state.activeTaskId = null;
            saveState();
            renderTasks(); // Re-render completo para evitar problemas de índices
        }

        // --- PICTURE IN PICTURE LOGIC ---
        
        async function togglePiP() {
            if (!window.documentPictureInPicture) {
                alert("Tu navegador no soporta PiP para documentos.");
                return;
            }

            // Si ya existe la ventana, la cerramos
            if (window.documentPictureInPicture.window) {
                window.documentPictureInPicture.window.close();
                return;
            }

            try {
                // 1. Abrir ventana
                const pipWindow = await window.documentPictureInPicture.requestWindow({
                    width: 320,
                    height: 400
                });

                // 2. Copiar Estilos (Scripts de Tailwind y Styles propios)
                const allStyles = [...document.querySelectorAll('style, link[rel="stylesheet"]')];
                // Truco para Tailwind en modo CDN: copiar el script
                const scripts = [...document.querySelectorAll('script')];
                
                scripts.forEach(s => {
                    if(s.src.includes('tailwindcss')) {
                        const scriptCopy = document.createElement('script');
                        scriptCopy.src = s.src;
                        pipWindow.document.head.appendChild(scriptCopy);
                        
                        // Necesitamos reinjectar la config de tailwind
                        const configScript = document.createElement('script');
                        configScript.textContent = `
                            tailwind.config = {
                                darkMode: 'class',
                                theme: { extend: { colors: { gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0f141e', } } } }
                            }
                        `;
                        pipWindow.document.head.appendChild(configScript);
                    }
                });

                allStyles.forEach(s => pipWindow.document.head.appendChild(s.cloneNode(true)));
                
                // Aplicar clase Dark Mode si es necesario
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) pipWindow.document.documentElement.classList.add('dark');
                
                // Configurar cuerpo de PiP
                pipWindow.document.body.className = `flex flex-col items-center justify-center h-full transition-colors duration-500 ${isDark ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'}`;

                // 3. FIX: Exponer funciones globales al scope de la nueva ventana
                // Esto soluciona que los botones 'onclick="resetTimer()"' no funcionen porque
                // buscaban la función en window del PiP, no en el opener.
                [
                    'toggleTimer', 
                    'resetTimer', 
                    'toggleSettings', 
                    'toggleDarkMode'
                ].forEach(funcName => {
                    pipWindow[funcName] = window[funcName];
                });

                // 4. Mover Contenido
                const timerContainer = document.getElementById('timer-container');
                const placeholder = document.getElementById('pip-placeholder');
                
                pipWindow.document.body.appendChild(timerContainer);
                
                // Mostrar placeholder en main window
                placeholder.classList.remove('hidden');

                // 5. Manejar cierre
                pipWindow.addEventListener('pagehide', (event) => {
                    const mainWrapper = document.getElementById('main-card-wrapper');
                    const tasksSection = document.getElementById('tasks-section');
                    
                    // Devolver contenido antes de la sección de tareas
                    mainWrapper.insertBefore(timerContainer, tasksSection);
                    placeholder.classList.add('hidden');
                });

            } catch (err) {
                console.error("Error al abrir PiP:", err);
            }
        }

        // Inicializar
        init();
        
        els.soundSelect.addEventListener('change', (e) => {
            state.sound = e.target.value;
            saveState();
        });

    </script>
</body>
</html>